# name: test/sql/mlpack_random_forest.test
# description: test random forest in mlpack extension
# group: [sql]

require mlpack

statement ok
PRAGMA enable_verification

statement ok
SET GLOBAL threads = 1;

# check mlpack_random_forest
# running commands from sampleCall.sh 
statement ok
CREATE TABLE X AS SELECT * FROM read_csv("docs/data/iris.csv");

statement ok
CREATE TABLE Y AS SELECT * FROM read_csv("docs/data/iris_labels.csv");

statement ok
CREATE TABLE Z (name VARCHAR, value VARCHAR);

statement ok
INSERT INTO Z VALUES ('ntrees', '6'), ('silent', 'true');

statement ok
CREATE TABLE M (key VARCHAR, json VARCHAR);

statement ok
CREATE TEMP TABLE A AS SELECT * FROM mlpack_random_forest_train("X", "Y", "Z", "M");

#query II
#SELECT COUNT(*) as n, predicted FROM A GROUP BY predicted;
#----
#50	0
#52	1
#48	2

statement ok
CREATE TABLE N (x1 DOUBLE, x2 DOUBLE, x3 DOUBLE, x4 DOUBLE);

statement ok
INSERT INTO N VALUES (5.843, 3.054, 3.759, 1.199), (4.3, 2.0, 1.0, 0.1), (7.9, 4.4, 6.9, 2.5);

statement ok
CREATE TEMP TABLE B AS SELECT * FROM mlpack_random_forest_pred("N", "M");

query I
SELECT * FROM B;
----
1
0
2

query II
SELECT COUNT(*) as n, predicted FROM B GROUP BY predicted;
----
1	0
1	1
1	2


statement ok
DROP TABLE A;

statement ok
DROP TABLE B;

statement ok
DROP TABLE X;

statement ok
DROP TABLE Y;

statement ok
DROP TABLE M;

statement ok
DROP TABLE Z;

statement ok
CREATE TABLE X AS SELECT * FROM read_csv("docs/data/covertype_small_features.csv.gz") LIMIT 500;

statement ok
CREATE TABLE Y AS SELECT * FROM read_csv("docs/data/covertype_small_labels.csv.gz") LIMIT 500;

statement ok
CREATE TABLE Z (name VARCHAR, value VARCHAR);

statement ok
INSERT INTO Z VALUES ('ntrees', '20'), ('silent', 'true'), ('seed', '20251104'), ('threads', '1');

statement ok
CREATE TABLE M (key VARCHAR, json VARCHAR);

statement ok
CREATE TEMP TABLE A AS SELECT * FROM mlpack_random_forest_train("X", "Y", "Z", "M");

### OpenMP gets in the way, 'SET threads = 1;' does not help
#query II
#SELECT COUNT(*) as n, predicted FROM A GROUP BY predicted;
#----
#183		0
#267		1
#20		2
#1		3
#4		4
#16		5
#9		6
